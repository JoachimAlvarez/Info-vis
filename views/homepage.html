<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.css">
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>InfoVis</title>
  </meta>
</head>
<style>
  body {
      font-family: Sans-serif;
      font-size: 0.75em;
  }
  .slice {
      cursor: pointer;
  }
  .slice .main-arc {
      stroke: #fff;
      stroke-width: 1px;
  }
  .slice .hidden-arc {
      fill: none;
  }
  .slice text {
      pointer-events: none;
      dominant-baseline: middle;
      text-anchor: middle;
  }
  .breadcrumbs {}
  .breadcrumb {
    font-weight: bold;
    font-size: 2em;
    cursor: pointer;
  }
  h2 {
    vertical-align: top;
    font-weight: bold;
    text-align: center;
    font-size: 2em;
  }
  p {
    text-align: left;
  }
  .sidebar {
    position: relative;
    float: right;
    width: 30%;
  }
  .item_info {
    width: 100%;
    clear: both;
    display: block;
    height: 350px;
    overflow:scroll;
  }
  .legenda {
    width: 100%;
    clear: both;
    height: 60px;
    display: inline-block;
  }
  .columnNav {
   float: left;
   width: 20%;
   height: 60px;
   vertical-align: middle;
  }
  .columnTitle {
   float: left;
   width: 60%;
   height: 60px;
   font-weight: bold;
    text-align: center;
    font-size: 3em;
  }
  .row {
    width: 100%;
    height: 60px;
    vertical-align: middle;
  }
  .columnNav input[type=text] {
   padding: 5px;
   margin-top: 20px;
   font-size: 17px;
   border: 1px solid gray;
   margin-left: 20px;
   float:left;
  }
  .columnNavRadio {
     padding: 35px;
     font-size: 17px;
  }
  .columnNav button {
  float: right;
  padding: 6px 10px;
  background: #ddd;
  margin-left: -20px;
  margin-top: 19px;
  font-size: 18px;
  border: none;
  cursor: pointer;
  float:left;
}
.columnNav button:hover {
  background: #ccc;
}

/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  width: 200px;
}

/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}
</style>
<body>

<div class="row">
  <div class="columnNav">
  <!--  <select id="combobox"></select>-->

    <form id='search'>
      <input id='searchInput' list="datalist" aria-autocomplete="options" type="text" placeholder="Search for Food(Group).." name="search">
      <button><i class="fa fa-search"></i></button>
      <datalist id="datalist"></datalist>
    </form>
	
	<!-- button for modal -->
	<button id="filterButton"><i class="fa fa-filter"></i></button>
	
	<!-- the filter modal -->
	<div id="filterModal" class="modal">
		<div class="modal-content">
			<span class="close">&times;</span>
			<p>Don't show food with:</p>
			<form id='filterForm'>
			  <input type="checkbox" name="food" value="Protein"> Protein<br>
			  <input type="checkbox" name="food" value="Gluten"> Gluten<br>
			  <input type="checkbox" name="food" value="Sugars"> Sugars<br>
			  <input type="checkbox" name="food" value="Cholesterol"> Cholesterol<br>
			  <input type="checkbox" name="food" value="Calcium (Ca)"> Calcium (Ca)<br>
			  <input type="checkbox" name="food" value="Copper (Cu)"> Copper (Cu)<br>
			  <input type="checkbox" name="food" value="Iron (Fe)"> Iron (Fe)<br>
			  <input type="checkbox" name="food" value="Sodium (Na)"> Sodium (Na)<br>
			  <input type="checkbox" name="food" value="Fiber"> Fiber<br>
			  <input type="checkbox" name="food" value="Vitamin A"> Vitamin A<br>
			  <input type="checkbox" name="food" value="Vitamin B12"> Vitamin B12<br>
			  <input type="checkbox" name="food" value="Vitamin B6"> Vitamin B6<br>
			  <input type="checkbox" name="food" value="Vitamin C"> Vitamin C<br>
			  <input type="checkbox" name="food" value="Vitamin D"> Vitamin D<br>
			  <input type="checkbox" name="food" value="Vitamin E"> Vitamin E<br>
			  <input type="checkbox" name="food" value="Vitamin K"> Vitamin K<br>
			  <input type="submit" value="Submit">
			</form> 
		</div>
	</div>
	
  </div>
  <h1 class="columnTitle" style="float: center;">Information Visualisation</h1>
  <div id="colorBlindForm" class='columnNavRadio'>
    <label>Color Blind Mode: </label>
    <input type="radio" name="radioName" value="true" /> On 
    <input type="radio" name="radioName" value="false" checked/> Off 
  </div>
</div>

<div id="sequence" class="breadcrumbs" style="float: left;width: 99%;height: 30px"></div>

<div style="height: 80%;float: bottom;">
  <div id="svg-div" style="width: 70%;float: left;"></div>
  <div id="sidebar" class='sidebar'>
    <div id="item_info" class='item_info'>
      <h2 id="item_name"></h2>
      <div id="info"></div>
    </div>
    <div id="legenda" class="legenda">
      <h2 id="d">Instructions</h2>
      <p style="text-align: center;"> (hover over the instructions to see them in action)</p>
      <p id="backInstr">  <b style="font-size: 1.25em;">Back:</b> <i style="font-size: 1.25em;">Click</i> at the center of the Visualisation</p>
      <p id="selectInstr"><b style="font-size: 1.25em;">Click/See:</b> <i style="font-size: 1.25em;">Hover</i> on the slice of the Visualisation. <i style="font-size: 1.25em;">Click</i> to go through</p>
      <h2 id="instr" style="text-align: center;">Current Action</h2>
        <p style="font-size: 1.25em;"> <b>Click: </b><span id="click_action"></span></p>
        <p style="font-size: 1.25em;"> <b>Hover: </b><span id="hover_action"></span></p>
      </p>
    </div>
  </div>
</div>

</body>
<script src="libs/jquery/dist/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="libs/d3/d3.js"></script>
<script type="text/javascript">

// ----------------------------------
// Instructions

let instr_busy = false;

function updateCurrentAction(d) {
  var name = d.data.name;
  $('#hover_action').text('see information about: '+name);
  if ((CURRENT_DEPTH-1) === d.depth) {
    $('#click_action').text('go Back to '+name);
  }
  else {
    $('#click_action').text('see subgroups of '+name);
  }
  

  var str_hover = "HOVER here to see information about: "+name;
  var str_subgroups = "";
  //var group_children = d.data.children;
  //group_children.forEach(child => { str_subgroups = str_subgroups + child.name + ', ' });
  var str_click = "CLICK here to see information about: "+str_subgroups
  $('#curr_actions').append(d.data.name);
}

function blinkHome(blink) {
  if (blink) {
    if (CURRENT_DEPTH === 0) {
      center.attr('fill', 'white');
    }
    else {
      setOpacity(CURRENT_D.parent, 1, 0.2);
    }
  }
  else {
    if (CURRENT_DEPTH === 0) {
      center.attr('fill', 'black');
    }
    else {
      setOpacity(CURRENT_D.parent, 0.2, 0.2);
    }
  }
}


$('#backInstr').on('mouseover', e => {
  if (!instr_busy) {
    d3.selectAll("path").style("opacity", 0.2);
    instr_busy = true;
  //  d3.selectAll("path").style("opacity", 0.2);
    setTimeout(() => {
       blinkHome(true);
       setTimeout(() => {
        blinkHome(false);
        setTimeout(() => {
          blinkHome(true);
          setTimeout(() => {
            blinkHome(false);
            setTimeout(() => {
              blinkHome(true);
              setTimeout(() => {
                blinkHome(false);
              //  d3.selectAll("path").style("opacity", 1);
                clickOn(CURRENT_D.parent)
                updateBreadcrumbs(CURRENT_D);
                updateInformation(CURRENT_D);
                setOpacity(CURRENT_D, 1, 0.2);
                instr_busy = false;
              }, 1000);
            }, 500);
          }, 500);
        }, 500);
      }, 500);
    }, 500);
  }
});

function blinkGroup(blink, child) {
  if (blink) {
    setOpacity(child, 1, 0.2);
  }
  else {
    setOpacity(child, 0.2, 0.2);
  }
}

$('#selectInstr').on('mouseover', e => {
  if (!instr_busy) {
    if (CURRENT_D.children) {
      const child = CURRENT_D.children[1];
      instr_busy = true;
    
      d3.selectAll("path").style("opacity", 0.2);
      setTimeout(() => {
        blinkGroup(true, child);
        setTimeout(() => {
          blinkGroup(false, child);
          setTimeout(() => {
            blinkGroup(true, child);
            setTimeout(() => {
              clickOn(child)
              if (CURRENT_D) {
                updateBreadcrumbs(CURRENT_D);
                updateInformation(CURRENT_D);
              }
              instr_busy = false
            }, 1000);
          }, 500);
        }, 500);
      }, 500);
    }
    else {
      alert('You are at maximum depth, you cannot go deeper in the visualisation');
    }
  }
});

// ----------------------------------
// Color Blindness

let COLOR_BLIND_MODE = false;
let COLOR_BLIND_COLORS = d3.scaleOrdinal(['#a50f15', '#de2d26', '#fb6a4a', '#cfae91', '#08519c', '#3182db', '#6baed6', '#636363', '#969696', '#cccccc']);
let NORMAL_COLORS = d3.scaleOrdinal(d3.schemeCategory10);
let color = d3.scaleOrdinal(d3.schemeCategory10);

$("input[type='radio']").change(function() {
  const val = $(this).val()
  if (val === 'true') {
    COLOR_BLIND_MODE = true;
    color = COLOR_BLIND_COLORS;
  }
  else {
    COLOR_BLIND_MODE = false;
    color = NORMAL_COLORS;
  }
  redraw();
});

function redraw() {
  $("#svg-div").empty();
  svg = d3.select("#svg-div").append("svg:svg")
    .attr("width", width)
    .attr("height", height)
    .append("svg:g")
    .attr("id", "container")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
    .on('click', clickOn);
  VisualiseData(DATA);
}

// ----------------------------------
// Search

let NAMES = [];

$('#search').submit(e => {
  const name = e.currentTarget[0].value;
  var d = false;
  svg.selectAll("path")
      .filter(node => {
        if (node.data.name === name) {
          d = node;
        }
      });
  if (d) {
    var anc = getAncestors(d);
    clickOn(anc[1]);
    updateInformation(d);
    updateBreadcrumbs(d);
    setOpacity(d, 1, 0.2);
  }
  else {
    alert("This item does not exist, please pick one from the list");
  }
  e.preventDefault();
});

function InitialiseAutocomplete(names) {
  var datalist = $('#datalist');
  names.forEach(name => {
    const option = '<option value="'+name+'"">';
    datalist.append(option)
  })
}

// -----------------------------------
// Init constants and helper functions

const formatNumber = d3.format(',d');
const width = $('#svg-div').width();// window.innerWidth;
const height = (window.innerHeight *80 /100); //$('#svg-div').height();//;
const radius = (Math.min(width, height) / 2) - 5;
const x = d3.scaleLinear().range([0, 2 * Math.PI]).clamp(true);
const y = d3.scaleSqrt().range([radius*.1, radius]);
const partition = d3.partition();

const arc = d3.arc()
    .startAngle(d => x(d.x0))
    .endAngle(d => x(d.x1))
    .innerRadius(d => Math.max(0, y(d.y0)))
    .outerRadius(d => Math.max(0, y(d.y1)))

const middleArcLine = d => {
    const halfPi = Math.PI/2;
    const angles = [x(d.x0) - halfPi, x(d.x1) - halfPi];
    const r = Math.max(0, (y(d.y0) + y(d.y1)) / 2);
    const middleAngle = (angles[1] + angles[0]) / 2;
    const invertDirection = middleAngle > 0 && middleAngle < Math.PI; // On lower quadrants write text ccw
    if (invertDirection) { angles.reverse(); }
    const path = d3.path();
    path.arc(0, 0, r, angles[0], angles[1], invertDirection);
    return path.toString();
};

const textFits = d => {
    const CHAR_SPACE = 6;
    const deltaAngle = x(d.x1) - x(d.x0);
    const r = Math.max(0, (y(d.y0) + y(d.y1)) / 2); // Changed
    const perimeter = r * deltaAngle;
    return d.data.name.length * CHAR_SPACE < perimeter;
};

// ---------------------------------------------------------------------
// This is the Visualisation

var svg = d3.select("#svg-div")
    .append("svg:svg")
    .attr("width", width)
    .attr("height", height)
    .append("svg:g")
    .attr("id", "container")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
    .on('click', clickOn);

//d3.select("#container").on("mouseleave", d => mouseLeave(d, true));

var center = svg.append("circle")
      .attr("r", radius / 10)
      .on("click", function(d) {});

  center.append("title")
      .text("Zoom Out");

// ---------------------------------------------------------------------
// Side Information

var Depths = { 0: 'Foods', 1: 'Food Groups', 2: 'Food Subgroups', 3: 'Food'}
const DEPTH = Object.keys(Depths).length;

function gradesSpan(min, max) {
  const solid_star = '<i class="fas fa-star"></i>';
  const empty_star = '<i class="far fa-star"></i>';
  const half_star  = '<i class="fas fa-star-half-alt"></i>';

  let html = '<span>';

  for (i = 0; i < Math.floor(min); i ++) {
    html += solid_star;
  }
  if (min % 1 != 0) {
    html += half_star;
  }
  for (i = 0; i < (5-Math.ceil(min)); i++) {
    html += empty_star;
  }

  html += ' - ';

  for (i = 0; i < Math.floor(max); i ++) {
    html += solid_star;
  }
  if (max % 1 != 0) {
    html += half_star;
  }
  for (i = 0; i < (5-Math.ceil(max)); i++) {
    html += empty_star;
  }
  

  html += '</span>';
  return html;
}

function showFoodInformation(d) {
  const name_scientific = d.data.name_scientific;
  const description = d.data.description || "Description not available";
  const parent_name = d.parent.data.name;
  const min_grade = d.data.min_grade;
  const max_grade = d.data.max_grade;

  var div = document.createElement('div');
  let html = '';
  if (name_scientific) {
    html += '<p style="text-align: center;"><b>Scientific Name:</b> '+name_scientific+'</p>'
  }
  html += '<p><b>Parent Group: </b>'+parent_name+'</p>';
  html += '<p><b>Grade Range: </b>'+gradesSpan(min_grade,max_grade)+'</p>';
  html += '<p>'+description+'</p>';
  div.innerHTML = html;

  document.getElementById('info').appendChild(div);
}

function showDishInformation(d) {

}

function showGroupInformation(d) {
  var info_div = $('#info');
  var group_name = d.data.name;
  var group_parent = group_name || d.parent.data.name;
  var grade = d.data.grade;
  var group_children = d.data.children || ""; // Bug that appears until foods are added to the system
  const min_grade = d.data.min_grade;
  const max_grade = d.data.max_grade;

  var str = "";
  group_children.forEach(child => { str = str + child.name + ', ' });
  str = str.substring(0, str.length - 2);

  var div = document.createElement('div');
  let html = "";
  html += '<p><b>Grade Rage: </b>'+gradesSpan(min_grade,max_grade)+'</p>';
  html += '<p><b>Click here to find subgroups such as:</b> '+str+'</p>';
  
  div.innerHTML = html;
 
  document.getElementById('info').appendChild(div);
}

function showHomeInformation(d) {
  var info_div = $('#info');
  var group_name = d.data.name;
  var div = document.createElement('div');
  var str = "";
  var group_children = d.data.children || "";
  group_children.forEach(child => { str = str + child.name + ', ' });
  str = str.substring(0, str.length - 2);
  let html = '<p><b>Click here to find subgroups such as:</b> '+str+'</p>';
  div.innerHTML = html;
  document.getElementById('info').appendChild(div);
}

function clearInformation(d) {
  var info_div = $('#info');
  let name = $('#item_name');
  
  if (d.depth === DEPTH) {
    name[0].innerText = "";
  }

  info_div.empty();
}

function updateInformation(d) {
  clearInformation(d);
  const name = d.data.name;
  let name_div = $('#item_name');
  name_div[0].innerText = name;

  switch(d.depth) {
    case 0: showHomeInformation(d); 
      break;
    case 1: showGroupInformation(d); 
      break;
    case 2: showGroupInformation(d); 
      break;
    case 3: showFoodInformation(d); 
      break;
    case 4: showDishInformation(d); 
      break;
    default: console.log("Error: unhandled depth", d);
  }
}

// ---------------------------------------------------------------------
// Clickable Breadcrumbs

function clearBreadCrumbs() {
  d3.select('.breadcrumbs').selectAll('.breadcrumb').remove();
};

function updateBreadcrumbs(d) {
    clearBreadCrumbs();

    const crumbContainer = d3.select('.breadcrumbs');
    const anc = getAncestors(d);

    // Add First: 'Foods'
    crumbContainer.append('span')
        .classed('breadcrumb', true)
        .text(anc[0].data.name)
        .on("click", (_, a ,f) => { clickOn(anc[0]) });

    // add rest
    for (i = 1; i < anc.length; i++) {
      const n = anc[i];
      crumbContainer.append('span')
        .classed('breadcrumb', true)
        .text("  >  "+n.data.name)
        .on("click", (_, a ,f) => { clickOn(n) });
    } 
}

function getAncestors(node) {
  var path = [];
  var current = node;
  while (current.parent) {
    path.push(current);
    current = current.parent;
  }
  path.push(current)
  path.reverse();
  return path;
}

// ---------------------------------------------------------------------
// Opacity

function setOpacity(d, op_highlight, op_dim) {
  var sequenceArray = getAncestors(d);
  d3.selectAll("path").style("opacity", op_dim);
  svg.selectAll("path")
      .filter(node => { return (sequenceArray.indexOf(node) >= 0)})
      .style("opacity", op_highlight);
}

// ---------------------------------------------------------------------
// UI listeners

function mouseOver(d) {
  updateBreadcrumbs(d);
  updateInformation(d);
  setOpacity(d, 1, 0.3);

  updateCurrentAction(d);
}

function mouseLeave(d, segment=false) { 

}

function clickOn(d) {
  if (d) { 
    CURRENT_D = d;
    const transition = svg.transition()
        .duration(750)
        .tween('scale', () => {
            const xd = d3.interpolate(x.domain(), [d.x0, d.x1]);
            const yd = d3.interpolate(y.domain(), [d.y0, 1]);
            return t => { x.domain(xd(t)); y.domain(yd(t)); };
        });
    transition.selectAll('path.main-arc').attrTween('d', d => () => arc(d));
    transition.selectAll('path.hidden-arc').attrTween('d', d => () => middleArcLine(d));
    
    const depth = d.depth;
    CURRENT_DEPTH = depth;
    
    transition.selectAll('path.main-arc').attr('display', d => (depth+3 > d.depth) ? null : 'none');
    transition.selectAll('path.hidden-arc').attr('display', d => (depth+3>d.depth) ? null : 'none');
    transition.selectAll('text').attr('display', d => (depth+3>d.depth) ? null : 'none');

    transition.selectAll('text').attrTween('display', d => () => textFits(d) ? null : 'none');
}
}

// ----------------------------------------------------------------------
// Sunburst

var CURRENT_DEPTH = 0;
var CURRENT_D = null;

function VisualiseData(data) {
  const root = d3.hierarchy(data)
      .sum(d => d.size);

  const slice = svg.selectAll('g.slice')
      .data(partition(root).descendants());
  slice.exit().remove();

  const newSlice = slice.enter()
      .append('g').attr('class', 'slice')
      .on('mouseover', mouseOver)
      .on('click', d => { d3.event.stopPropagation(); clickOn(d) })
      //.attr('display', d => (CURRENT_DEPTH+2>=d.depth) ? null : 'none');

  newSlice.append('title')
      .text(d => d.data.name);
  newSlice.append('path')
      .attr('class', 'main-arc')
      .style('fill', d => color((d.children ? d : d.parent).data.name)) // todo
      .attr('d', arc);
  newSlice.append('path')
      .attr('class', 'hidden-arc')
      .attr('id', (_, i) => `hiddenArc${i}`)
      .attr('d', middleArcLine);

  const text = newSlice.append('text')
      .attr('display', d => textFits(d) ? null : 'none');
  text.append('textPath')
      .attr('startOffset','50%')
      .attr('xlink:href', (_, i) => `#hiddenArc${i}`)
      .text(d => d.data.name);

  var home = svg.selectAll("path")._groups[0][0].__data__;
  CURRENT_D = home;
  updateInformation(CURRENT_D);
  updateBreadcrumbs(CURRENT_D);
  clickOn(home);
}

/*
var partitioned_data = partition.nodes(d3.hierarchy(DATA)).slice(1)
function filter_min_arc_size_text(d, i) {return (d.dx*d.depth*radius/1)>14};
function isRotated(d) {
    var rotation = (d.x + d.dx / 2) * 180 / Math.PI - 90;
    return rotation > 90 ? true : false
}

var texts = svg.selectAll("text")
      .data(partitioned_data)
      .enter()
      .append("text")
      .filter(filter_min_arc_size_text)
      .attr("transform", d => {
          var r = computeTextRotation(d);
          return "rotate(" + r.global + ")"
            + "translate(" + radius / 3. * d.depth + ")"
            + "rotate(" + -r.correction + ")";
      })
      .style("font-weight", "bold")
      .style("text-anchor", "middle")
      .attr("dx", d => {return isRotated(d) ? "-85" : "85"}) //margin
      .attr("dy", ".35em") // vertical-align
      .on("click", clickOn)
      .text( (d,i) => {return d.name})
*/
// ---------------------------------------------------------------------
// Fetch the data and show the visualisation

let DATA = {};

$.ajax({
  type: 'GET',
  contentType: 'application/json',
  url: 'http://localhost:4000/getFoodGroups',
  success: data => {
    DATA = data.json;
    InitialiseAutocomplete(data.names);
    VisualiseData(DATA);
  },
  error: (xhr, status, error) => {
    console.log(error)
  },
});

// ------------ FILTER MODAL ------------
// Get the modal
var modal = document.getElementById("filterModal");

// Get the button that opens the modal
var btn = document.getElementById("filterButton");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal 
btn.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

</script>
</html>